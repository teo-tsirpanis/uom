# Τεχνικές προσομοίωσης ~ Εργασία 3

### Θοδωρής Τσιρπάνης (`dai19090`)

## Εισαγωγή

Στο πλαίσιο της επιλογής θέματος της τρίτης εργασίας του μαθήματος "Τεχνικές Προσομοίωσης" περιέγραψα την ιδέα μου στο παρακάτω email:

> ### Ένα σύστημα ανελκυστήρων
>
> Από τότε που ξεκίνησα την φοίτησή μου στο τμήμα με παραξένευε ο τρόπος με τον οποίο λειτουργούν οι ανελκυστήρες κάθε πύργου του ΠΑΜΑΚ, και συγκεκριμένα η ύπαρξη δύο ζευγαριών κουμπιών πάνω και κάτω, αντί για ένα ζευγάρι κουμπιών που θα ελέγχει και τους δύο ανελκυστήρες, προσφέροντας αποδοτικότερη δρομολόγηση. Η περιέργεια αυτή με οδήγησε στην σκέψη να φτιάξω ένα σύστημά που θα προσομοιώνει την κίνηση μιας ομάδας ανελκυστήρων σε ένα κτήριο, και τους ανθρώπους που έρχονται στο ισόγειο, μετακινούνται στους ορόφους, και μετά από κάποιο διάστημα επιστρέφουν στο ισόγειο και φεύγουν.
>
> Θα παραμετροποιούνται μεταξύ άλλων το πλήθος των ορόφων, το πλήθος των ανελκυστήρων, η ταχύτητα των ανελκυστήρων, η συχνότητα άφιξης των ανθρώπων, η μέση διάρκεια παραμονής τους, η διάρκεια της προσομοίωσης, και κυριότερα η στρατηγική δρομολόγησης των ανελκυστήρων (αν θα υπάρχουν ένα ή πολλά σετ κουμπιών και αν θα λαμβάνουν υπόψη αν ο άνθρωπος θέλει να πάει πάνω ή κάτω).
>
> Η προσομοίωση θα βγάζει ως αποτελέσματα μετρικές αποδοτικότητας όπως τον μέσο χρόνο αναμονής των ανθρώπων και την συνολική απόσταση που διένυσαν οι ανελκυστήρες, επιτρέποντας την σύγκριση των διαφορετικών στρατηγικών δρομολόγησης.

Δύο μήνες αργότερα η εργασία έχει ολοκληρωθεί, και η αναφορά αυτή περιγράφει το σύστημα υπό προσομοίωση, καθώς και κάποια στοιχεία της υλοποίησής του.

## Το σύστημα υπό προσομοίωση

Όπως αναφέρθηκε προηγουμένως, το σύστημα προσομοιώνει την καθημερινή κίνηση σε ένα πολυόροφο κτήριο με έναν ή περισσότερους ανελκυστήρες και χωρίς σκάλες.

Μέσα στην ημέρα, έρχεται ένα πλήθος ανθρώπων στο ισόγειο και περιπλανιέται στους διάφορους ορόφους του κτηρίου μετακινούμενο με τους ανελκυστήρες, επιστρέφοντας κάποια στιγμή στο ισόγειο και φεύγοντας από το κτήριο. Μπορούμε να δείξουμε με ψευδοκώδικα τις δραστηριότητες ενός ανθρώπου μέσα στο κτήριο:

### Αλγόριθμος Ανθρώπου

1. Μπες στο κτήριο από την πόρτα του ισογείου.
1. Επανάλαβε για έναν κανονικά κατανεμημένο τυχαίο αριθμό φορών αλλά τουλάχιστον μία φορά:
    1. Πήγαινε στην ουρά για τον ανελκυστήρα στον όροφο που βρίσκεσαι.
    1. Όταν έρθει η σειρά σου επανάλαβε μέχρι να μπορέσεις να μπεις σε κάποιον ανελκυστήρα:
        1. Πάτησε το κουμπί της κατεύθυνσης που θέλεις να πας και περίμενε να έρθει κάποιος ανελκυστήρας.
        1. Όταν έρθει, περίμενε να ανοίξει η πόρτα.
        1. Όταν ανοίξει η πόρτα του ανελκυστήρα, μπες μέσα αν υπάρχει αρκετός χώρος.
        1. Αν ο ανελκυστήρας είναι γεμάτος, περίμενε μέχρι να φύγει και κάλεσέ τον ξανά.
    1. Διάλεξε έναν ομοιόμορφα κατανεμημένο τυχαίο αριθμό του ορόφου στον οποίο θα πας, ο οποίος πρέπει να έιναι διαφορετικός από τον αριθμό του ορόφου που βρίσκεσαι και όχι το ισόγειο.
    1. Περίμενε να φτάσει ο ανελκυστήρας στον όροφο που επέλεξες και να ανοίξει την πόρτα του.
    1. Βγες από τον ανελκυστήρα, και μείνε στον όροφο για μία κανονικά κατανεμημένη χρονική ποσότητα.
1. Τέλος επανάληψης.
1. Ακολούθησε τα βήματα 2.2.1 έως 2.2.3.
1. Όταν μπεις μέσα στον ανελκυστήρα, πάτησε το κουμπί για να πας στο ισόγειο.
1. Περίμενε να φτάσει ο ανελκυστήρας στο ισόγειο και να ανοίξει την πόρτα του.
1. Βγες από το κτήριο.

Η άφιξη των ανθρώπων στο κτήριο περιγράφεται με τον εξής ψευδοκώδικα:

### Αλγόριθμος Άφιξης Ανθρώπων

1. Επανάλαβε έναν ορισμένο αριθμό φορών:
    1. Εκκίνησε τον _Αλγόριθμο Ανθρώπου_ αλλά ασύγχρονα, χωρίς να περιμένεις τον τερματισμό του.
    1. Περίμενε για μία εκθετικά κατανεμημένη χρονική ποσότητα.

Η ασύχρονη εκτέλεση του _Αλγορίθμου Ανθρώπου_ στο βήμα 1.1 του _Αλγορίθμου Άφιξης Ανθρώπων_ επιτρέπει την ταυτόχρονη παρουσία πολλών ανθρώπων μέσα στο κτήριο.

Όταν οι άνθρωποι καλούν τον ανελκυστήρα, το αίτημά τους το επεξεργάζεται μια οντότητα που λέγεται ο _ελεγκτής ανελκυστήρων_. Ο ψευδοκώδικας της λειτουργίας του ελεγκτή ανελκυστήρων είναι ο εξής:

### Αλγόριθμος Ελεγκτή Ανελκυστήρων

1. Όταν λάβεις κάποιο αίτημα κατά το βήμα 2.2.1 του _Αλγορίθμου Ανθρώπου_, με ορίσματα τον όροφο από όπου έλαβες το αίτημα και την κατεύθυνση μετακίνησης:
    1. Αν στο κτήριο υπάρχει μόνο ένας ανελκυστήρας:
        1. Στείλε αίτημα στον ανελκυστήρα αυτόν για να σταματήσει στον όροφο.
    1. Αλλιώς:
        1. Με βάση μια _στρατηγική_, διάλεξε τουλάχιστον έναν ανελκυστήρα για να του(ς) στείλεις αίτημα να πάνε στον όροφο.

Υλοποιήθηκαν δύο στρατηγικές δρομολόγησης ανελκυστήρων, η _απλή_ και η _έξυπνη_· ο σκοπός της εργασίας είναι η σύγκρισή τους. Θα τις περιγράψουμε με ελεύθερο κείμενο:

* Η __απλή στρατηγική__ παρομοιάζει την συμπεριφορά του μέσου χρήστη των ανελκυστήρων του ΠΑΜΑΚ: καλεί τον πιο κοντινό ανελκυστήρα στον όροφο που ελήφθη το αίτημα, και αν κάποιοι ανελκυστήρες ισαπέχουν, καλεί όλους τους ισαπέχοντες.
* Η __έξυπνη στρατηγική__ χρησιμοποιεί περισσότερες πληροφορίες: καλεί τον πιο κοντινό ανελκυστήρα στον όροφο που ελήφθη το αίτημα, ο οποίος πρέπει είτε να είναι ανενεργός, είτε να είναι ακίνητος και να βρίσκεται στον όροφο που ελήφθη το αίτημα, είτε να κινείται προς την κατεύθυνση του αίτηματος και να πλησιάζει τον όροφο (δηλαδή να βρίσκεται κάτω απ' τον όροφο και να κινείται προς τα πάνω, ή πάνω από τον όροφο και να κινείται προς τα κάτω). Αν κανένας ανελκυστήρας δεν πληρεί τα κριτήρια τη δεδομένη χρονική στιγμή, ακολουθεί το παράδειγμα της απλής στρατηγικής και καλεί τον πιο κοντινό από όλους τους ανελκυστήρες, αλλά σε κάθε περίπτωση καλεί μόνο έναν· αν κάποιοι ανελκυστήρες ισαπέχουν, καλεί έναν τυχαίο από αυτούς.

### Οι ανελκυστήρες

Ανεξαρτήτως της στρατηγικής του ελεγκτή λειτουργεί ο μεμονωμένος ανελκυστήρας. Η λογική του είναι η πιο σύνθετη από τις οντότητες του συστήματος, κυρίως επειδή ο ανελκυστήρας διατηρεί μια εσωτερική κατάσταση που αποτελείται από τις εξής τιμές:

* Ο **αριθμός ορόφου** του κτηρίου που βρίσκεται ο ανελκυστήρας. Στην αρχή βρίσκεται στο ισόγειο (στον όροφο μηδέν).
* Η **κατάσταση κίνησης** του ανελκυστήρα, είτε _ακίνητος_ είτε _εν κινήσει_. Στην αρχή είναι _ακίνητος_.
* Η **κατεύθυνση** προς την οποία κινείται ο ανελκυστήρας, πάνω ή κάτω. Εφόσον ο ανελκυστήρας ξεκινά ακίνητος, η αρχική τιμή της κατεύθυνσής του δεν έχει νόημα.
* Η **κατάσταση ενεργοποίησης** του ανελκυστήρα, είτε _ενεργός_, είτε _προς ενεργοποίηση_ είτε _ανενεργός_. Στην αρχή είναι _ανενεργός_.
* Η **κατάσταση πόρτας** του ανελκυστήρα, είτε _ανοιχτή_, είτε _προς άνοιγμα_, είτε _προς κλείσιμο_, είτε _κλειστή_. Στην αρχή είναι _κλειστή_. Στην πραγματικότητα υπάρχουν πολλές πόρτες του ίδιου ανελκυστήρα σε κάθε όροφο, αλλά εφόσον μόνο μία μπορεί να είναι ανοιχτή κάθε φορά, χρησιμοποιούμε μόνο μία μεταβλητή για να αποθηκεύσουμε την κατάστασή της.
* Οι **καλούντες όροφοι**, ένα σύνολο των αριθμών των ορόφων του κτηρίου, συμπεριλαμβανομένου του ισογείου. Στην αρχή είναι κενό.
* Οι **επιβάτες**, ένα σύνολο των αριθμών των επιβάτων που βρίσκονται στον ανελκυστήρα, μαζί με τον αριθμό ορόφου στον οποίον θέλουν να πάνε. Στην αρχή είναι κενό.

Δεν είναι όλοι οι συνδυασμοί τιμών έγκυροι. Για παράδειγμα ο ανελκυστήρας δε μπορεί να κινείται αν δεν είναι ενεργός, ή αν η πόρτα δεν είναι κλειστή.

Ο αλγόριθμος του ανελκυστήρα είναι αρκετά πολύπλοκος για να περιγραφτεί με ψευδοκώδικα (περιγράφεται άλλωστε με πραγματικό κώδικα στο αρχείο `ElevatorSim/Elevator.cs`), οπότε θα γράψουμε τις απαιτήσεις που πρέπει να πληροί:

* Ο ανελκυστήρας μεταβαίνει από την ανενεργή κατάσταση στην κατάσταση προς ενεργοποίηση, όταν κληθεί να πάει σε κάποιον όροφο διαφορετικό από αυτόν που βρίσκεται, όπου και θέτει την κατεύθυνσή του ανάλογα. Μεταβαίνει στην ενεργή κατάσταση όταν η πόρτα κλείσει. Ο διαχωρισμός των καταστάσεων σε ενεργή και προς ενεργοποίηση υπάρχει για να αποφευχθεί η ταυτόχρονη ενεργοποίηση του ανελκυστήρα από πολλούς ορόφους.
* Μόλις ενεργοποιηθεί, ο ανελκυστήρας αρχίζει να κινείται προς την κατεύθυνσή του, μεταβάλλοντας τον αριθμό ορόφου του κατά ένα ή μείον ένα, περίμένοντας μια σταθερή χρονική ποσότητα κάθε φορά.
* Όταν ο ανελκυστήρας κληθεί να πάει σε κάποιον όροφο προσθέτει τον αριθμό του ορόφου στο σύνολο των καλούντων ορόφων, και εφαρμόζει το πρώτο bullet point.
* Ο ανελκυστήρας εξυπηρετεί πρώτα τους καλούντες ορόφους που βρίσκονται μπροστά του προς την κατεύθυνσή του, η οποία αντιστρέφεται μόνο όταν ο ανελκυστήρας δεν έχει κανέναν καλούντα όροφο μπροστά του αλλά έχει από την αντίθετη κατεύθυνση.
* Αν το σύνολο των καλούντων ορόφων του ανελκυστήρα είναι κενό, σταματάει να κινείται και μεταβαίνει στην ανενεργή κατάσταση.
* Ο ανελκυστήρας σταματάει να κινείται και όταν ο αριθμός ορόφου του ανήκει στους καλούντες ορόφους. Στην περίπτωση αυτήν ανοίγει την πόρτα, και αφού ανοίξει, αφαιρεί τους επιβάτες που ήθελαν να σταματήσουν στον όροφο αυτόν, και αφαιρεί τον αριθμό ορόφου του από τους καλούντες ορόφους. Συνεχίζει την κίνηση κατά το δεύτερο bullet point αφού κλείσει η πόρτα του.
* Η πόρτα του ανελκυστήρα μεταβαίνει από την κλειστή κατάσταση στην κατάσταση προς άνοιγμα, αμέσως όταν κληθεί να ανοίξει. Μεταβαίνει στην ανοιχτή κατάσταση μετά την παρέλευση μιας σταθερής χρονικής ποσότητας.
* Μετά την παρέλευση μιας σταθερής χρονικής ποσότητας από το άνοιγμα, η πόρτα αρχίζει να κλείνει και μεταβαίνει από την ανοιχτή κατάσταση στην κατάσταση προς κλείσιμο.
* Αφού περιμένει για μια σταθερή χρονική ποσότητα μετά την μετάβαση στην κατάσταση προς κλείσιμο, αν η πόρτα παραμένει στην κατάσταση αυτήν, μεταβαίνει στην κλειστή κατάσταση, αλλιώς μεταβαίνει στην ανοιχτή κατάσταση, όπου εφαρμόζεται ξανά το αμέσως προηγούμενο bullet point.
* Καθώς η πόρτα βρίσκεται στην κατάσταση προς κλείσιμο, αν κληθεί να ανοίξει, μεταβαίνει αμέσως στην κατάσταση προς άνοιγμα.

## Η προσομοίωση του συστήματος

Έχοντας περιγράψει με λεπτομέρια το σύστημα που θα προσομιώσω, ας μιλήσουμε για την προσομοίωσή του. Είναι γραμμένη στην γλώσσα προγραμματισμού C# και εκτελείται στο περιβάλλον .NET. Αποτελείται από περίπου 3500 γραμμές κώδικα, και χωρίζεται σε δύο project:

* Η βιβλιοθήκη `Core` περιέχει τον κώδικα χαμηλότερου επιπέδου που ασχολείται με την παραγωγή τυχαίων αριθμών, τον μηχανισμό ροής χρόνου, κάποια προτεύοντα γενικής χρήσης όπως την ουρά αναμονής που έχει ο κάθε όροφος, και κλάσεις υπεύθυνες για την καταγραφή γεγονότων και λήψη στατιστικών. Θεωρητικά το `Core` μπορεί να χρησιμοποιηθεί και για άλλων ειδών προσομοιώσεις.
* Το πρόγραμμα `ElevatorSim` περιέχει τον κώδικα υψηλότερου επιπέδου της προσομοίωσης, που ορίζει την συμπεριφορά οντοτήτων άμεσα συσχετισμένων με το σύστημα υπό προσομοίωση όπως τους ανελκυστήρες, τον ελεγκτή τους, τις στρατηγικές του, και τους ανθρώπους που έρχονται στο κτήριο. Προσφέρει επιπλέον μια απλή διεπαφή γραμμής εντολών που δέχεται τις παραμέτρους του συστήματος και γράφει τα αποτελέσματα σε ένα αρχείο.

Καθώς η οδηγία είναι να μην σταλεί αρχείο `zip` αλλά μόνο `pdf`, και επειδή δεν είναι πρακτικό να τον αντιγράψω στην αναφορά λόγω του μεγέθους του, ο κώδικας της προσομοίωσης βρίσκεται στο GitHub στη διεύθυνση https://github.com/teo-tsirpanis/uom/tree/master/s7/simulation-techniques.

Η προσομοίωση είναι άκρως παραμετροποιήσιμη, επιτρέποντας συνολικά την ρύθμιση των κάτωθι δεκατεσσάρων τιμών από τον χρήστη σε ένα αρχείο JSON όπως θα δούμε στη συνέχεια:

* Το πλήθος των ορόφων στο κτήριο.
* Το πλήθος των ανελκυστήρων στο κτήριο.
* Το συνολικό πλήθως ανθρώπων που θα έρθουν στο κτήριο.
* Την χρονική διάρκεια σε δευτερόλεπτα που χρειάζεται ένας ανελκυστήρας για να ταξιδέψει από έναν όροφο σε έναν άλλο.
* Την χρονική διάρκεια σε δευτερόλεπτα που χρειάζεται ένας ανελκυστήρας για να ανοίξει ή να κλείσει την πόρτα του.
* Την χρονική διάρκεια σε δευτερόλεπτα που η πόρτα του ανελκυστήρα μένει ανοιχτή.
* Το μέγιστο πλήθος ατόμων που μπορεί να χωρέσουν σε έναν ανελκυστήρα κάθε φορά.
* Το σχήμα της κανονικής κατανομής (μέση τιμή και τυπική απόκλιση) της διάρκειας παραμονής των ανθρώπων σε κάθε όροφο σε δευτερόλεπτα.
* Το σχήμα της κανονικής κατανομής (μέση τιμή και τυπική απόκλιση) του συνολικού αριθμού ορόφων που θα επισκεφτεί κάθε άνθρωπος πριν φύγει από το κτήριο.
* Την μέση χρονική διάρκεια σε δευτερόλεπτα μεταξύ των αφίξεων των ανθρώπων στο κτήριο.
* Την στρατηγική του ελεγκτή των ανελκυστήρων (απλή ή έξυπνη). Αγνοείται αν υπάρχει μόνο ένας ανελκυστήρας στο κτήριο.
* Την τιμή αρχικοποίησης της γεννήτριας τυχαίων αριθμών. Αν παραλειφθεί, θα επιλεχθεί μια κρυπτογραφικά τυχαία τιμή.

Σε απάντηση στο email της εισαγωγής, δέχτηκα την πρόταση να υπάρχουν πάντα δύο ανελκυστήρες για την απλοποίηση της υλοποίησης, αλλά δεν την έλαβα υπ' όψιν επειδή η υλοποίηση δε γίνεται σημαντικά δυσκολότερη με ένα μεταβλητό πλήθος ανελκυστήρων έναντι ενός σταθερού.

Ας μιλήσουμε για κάποια στοιχεία της υλοποίησης:

### Η γεννήτρια τυχαίων αριθμών

Την παραγωγή τυχαίων αριθμών για την προσομοίωση την έχει αναλάβει η γεννήτρια PCG-XSH-RR 64/32 [της οικογένειας γεννητριών PCG](https://www.pcg-random.org/). Χρησιμοποιεί μια 64-μπιτη γραμική ισοϋπόλοιπη γεννήτρια το αποτέλεσμα της οποίας το περνάει από μια μη αναστρέψιμη συνάρτηση που ενισχύει την τυχαιότητα του αριθμού, συρρικνώνοντάς τον σε 32-μπιτο, και πετυχαίνοντας εξαιρετικές στατιστικές ιδιότητες.

Η υλοποίησή της γεννήτριας βρίσκεται στον φάκελο `Core/Randomness`. Μέσα στο αρχείο `RandomNumberGeneratorExtensions.cs` βρίσκεται ο κώδικας που παράγει τυχαία δείγματα σε διάφορες κατανομές. Η υλοποίηση των κατανομών βασίστηκε σε τρίτα έργα τα οποία αναφέρονται στα σχόλια του κώδικα.

> Ο φάκελος `RandomNumbers` περιέχει την γεννήτρια της πρώτης εργασίας του μαθήματος και δεν χρησιμοποιήθηκε σε αυτήν την εργασία.

### Ο μηχανισμός ροής χρόνου

Η πάροδος του χρόνου υλοποιείται με έναν μηχανισμό ροής χρόνου επόμενου γεγονότος. Τα γεγονότα - που στον κώδικα αποκαλούνται αντικείμενα έργου (_work items_) τοποθετούνται σε μια ουρά προτεραιότητας και αφαιρούνται από αυτήν κατά αύξουσα σειρά της χρονικής στιγμής που είναι προγραμματισμένα να εκτελεστούν. Η ουρά προτεραιότητας χρησιμοποιεί την κλάση `PriorityQueue` του συστήματος που είναι αποδοτικά υλοποιημένη με σωρό ελαχίστων. Αντικείμενα έργου μπορούν να προστεθούν στην ουρά για να εκτελεστούν είτε την ίδια χρονική στιγμή (χρήσιμο για την σηματοδότηση γεγονότων όπως ότι έφτασε ο ανελκυστήρας ή ότι άνοιξε η πόρτα), είτε μετά από κάποια χρονική ποσότητα (χρήσιμο για την συνέχιση μιας εργασίας στο μέλλον).

Το ρολόι της προσομοίωσης προχωράει ανάλογα τον προγραμματισμένο χρόνο του τρέχοντος εκτελούντος αντικειμένου έργου. Η προσομοίωση τελειώνει όταν εξαντληθούν τα αντικείμενα έργου στην ουρά. Στη βιβλιοθήκη `Core` ο χρόνος μετριέται σε αφηρημένες χρονικές μονάδες, οι οποίες στο σύστημά μας ερμηνεύονται ως δευτερόλεπτα.

Ο μηχανισμός καθίσταται εξαιρετικά απλός και διαφανής στην χρήση, χάρη στις δυνατότητες της γλώσσας που κάνουν την πιο δύσκολη δουλειά αντί για εμάς. Ας δούμε ένα παράδειγμα ροής χρόνου στην υλοποίηση του _Αλγορίθμου Άφιξης Ανθρώπων_:

```csharp
private async SimulationOp SimulationMain()
{
    // We generate the people beforehand to ensure identical results
    // accross elevator controller implementations that might use randomness.
    var allArrivals = new (Person Person, int TimeUntilNext)[_simulationOptions.TotalArrivals];
    var scale = 1.0f / _simulationOptions.MeanTimeBetweenArrivals;
    for (int i = 1; i <= allArrivals.Length; i++)
    {
        allArrivals[i - 1] = (GenerateRandomPerson(i), RoundToInt(_random.NextSingleExponential(scale)));
    }

    foreach (var arrival in allArrivals)
    {
        _ = PersonMain(arrival.Person);
        await Simulation.Delay(arrival.TimeUntilNext);
    }
}
```

Η ευκολία της υλοποίησης βρίσκεται στις λέξεις-κλειδιά `async` και `await`. Η πρώτη λέξη σημαίνει ότι η συνάρτηση `SimulationMain` είναι ασύχγρονη, και επιτρέπει την χρήση της δεύτερης λέξης. Η εντολή `await Simulation.Delay(arrival.TimeUntilNext);` σταματάει στη μέση την εκτέλεση της συνάρτησης `SimulationMain`, δημιουργεί ένα αντικείμενο έργου, και το προγραμματίζει να εκτελεστεί μετά από κάποιες χρονικές μονάδες, το οποίο όταν εκτελεστεί θα επιστρέψει από εκεί που το αφήσαμε. Αντίθετα η συνάρτηση `PersonMain` από πάνω καλείται αλλά χωρίς το `await`, που σημαίνει ότι δε θα περιμένουμε να φύγει ένας άνθρωπος για να έρθει ο επόμενος. Με αυτόν τον τρόπο έχουμε έναν αυθαίρετο αριθμό εργασιών αυθαίρετης πολυπλοκότητας να εκτελούνται ταυτόχρονα, αλλά όχι παράλληλα (όλη η προσομοίωση εκτελείται σε ένα νήμα), ούτε προεκτοπιστικά (_preemptively_) (μια εργασία θα εκτελείται συνεχόμενα μέχρι να περιμένει κάποια άλλη με τη λέξη `await`). Και όπως είδαμε πριν, ο χρόνος της προσομοίωσης προχωράει μόνο με την εντολή `await Simulation.Delay(x)`.

Για την αλληλεπίδραση με τις λέξεις `async` και `await` πήρα κάποιες ιδέες από την βιβλιοθήκη του .NET.

### Η καταγραφή γεγονότων

Διάσπαρτα στον κώδικα υπάρχουν κλήσεις της μεθόδου `ISimulationState.LogMessage` που επιτρέπουν λεπτομερέστατη απεικόνιση των γεγονότων που συμβαίνουν κάθε δευτερόλεπτο. Ας δούμε ένα παράδειγμα γεγονότων που συμβαίνουν στην αρχή της προσομοίωσης:

```
[D1 08:00:00 citizen_1] Entered the building, will visit 5 floors in total
[D1 08:00:00 citizen_1] Time to go to floor 1 and stay there for 00:29:42
[D1 08:00:00 floor_0] citizen_1 entered the queue
[D1 08:00:00 floor_0] citizen_1 found an empty queue and will be served immediately
[D1 08:00:00 elevator_1] Summoned to floor 0 from floor 0
[D1 08:00:00 elevator_1] Opening doors
[D1 08:00:00 elevator_2] Summoned to floor 0 from floor 0
[D1 08:00:00 elevator_2] Opening doors
[D1 08:00:03 elevator_1] Opened doors
[D1 08:00:03 elevator_2] Opened doors
[D1 08:00:03 citizen_1] Entered elevator_1, going to floor 1
[D1 08:00:03 floor_0] citizen_1 is leaving the queue
[D1 08:00:03 floor_0] The queue is now empty
[D1 08:00:15 elevator_2] Closing doors
[D1 08:00:15 elevator_1] Closing doors
[D1 08:00:18 elevator_2] Closed doors
[D1 08:00:18 elevator_1] Closed doors
[D1 08:00:18 elevator_1] Sprung into motion, heading Up
[D1 08:00:28 elevator_1] At floor 1
[D1 08:00:28 elevator_1] Stopped at floor 1
[D1 08:00:28 elevator_1] Opening doors
[D1 08:00:31 elevator_1] Opened doors
[D1 08:00:31 citizen_1] Left elevator_1, arrived at floor 1
[D1 08:00:43 elevator_1] Closing doors
[D1 08:00:46 elevator_1] Closed doors
[D1 08:00:46 elevator_1] Resting at floor 1
```

Κάθε γραμμή αντιστοιχεί σε ένα γεγονός και περιέχει την ώρα που συνέβη (για σκοπούς παρουσίασης η προσομοίωση θεωρείται ότι ξεκινάει στις 8 το πρωί), την οντότητα που προκάλεσε το γεγονός, και ένα μήνυμα.

### Η συλλογή δεδομένων

Η προσομοίωση συλλέγει πολλά ποσοτικά δεδομένα με τη βοήθεια οντοτήτων που λέγονται _όργανα_. Υπάρχουν τα εξής όργανα για την προσομοίωση:

* Ένα όργανο που μετράει στατιστικά για το ίδιο το σύστημα και την ουρά αντικειμένων έργου.
* Ένα όργανο που μετράει στατιστικά για τους ανθρώπους που έρχονται στο κτήριο, και τους χρόνους αναμονής και παραμονής τους.
* Ένα όργανο για κάθε ανελκυστήρα που μετράει στατιστικά για τη λειτουργία του.
* Ένα όργανο για κάθε όροφο εκτός του ισογείου που μετράει στατιστικά για τα άτομα που βρίσκονται σε αυτόν, και τους χρόνους αναμονής και παραμονής τους.
* Ένα όργανο για την ουρά αναμονής κάθε ορόφου που μετράει στατιστικά για τις αφίξεις σε αυτήν, τον χρόνο αναμονής των ανθρώπων, και το μήκος της.

## Αποτελέσματα

Έχοντας περιγράψει την υλοποίηση του συστήματος, ας δούμε μερικά αποτελέσματα. Το πρόγραμμα `ElevatorSim` παράγει αναφορές σε μορφοποιημένο κείμενο που περιλαμβάνουν τις μετρήσεις του κάθε οργάνου και τα καταγεγραμμένα γεγονότα.

Ακολουθούν οι αναφορές για δύο προσομοιώσεις που διαφέρουν μόνο στην στρατηγική του ελεγκτή ανελκυστήρων. Πρώτα με την απλή στρατηγική και μετά με την έξυπνη:

---

https://github.com/teo-tsirpanis/uom/blob/master/s7/simulation-techniques/ElevatorSim/Examples/simple.md

---

https://github.com/teo-tsirpanis/uom/blob/master/s7/simulation-techniques/ElevatorSim/Examples/smart.md

---

## Συμπεράσματα

Η έξυπνη στρατηγική δρομολόγησης αποδείχτηκε λίγο πιο αποδοτική από την απλή, λαμβάνοντας υπ' όψιν το κατά μία ποσοστιαία μονάδα μικρότερο μέσο ποσοστό του χρόνου που πέρασαν οι άνθρωποι στο κτήριο περιμένοντας. Κρίνοντας από το μεγάλο πλήθος επιλογών παραμετροποίησης της προσομοίωσης, πιθανόν σε άλλες περιπτώσεις η διαφορά να είναι μεγαλύτερη, αλλά η εκτίμησή μου είναι ότι η έξυπνη στρατηγική είναι καλύτερη επειδή καλεί μόνο έναν ανελκυστήρα ανά άτομο κάθε φορά.

## Μελλοντικά σχέδια

Σκέφτομαι μετά την εκπνοή της προθεσμίας της εργασίας να δημιουργήσω μια διαδραστική ιστοσελίδα που επιτρέπει την διαδραστική εκτέλεση της προσομοίωσης, και τον πειραματισμό με διάφορες παραμέτρους, χωρίς την εκτέλεση προγραμμάτων από τη γραμμή εντολών. Αν τελικά την κάνω, θα είναι διαθέσιμη στο https://elevatorsim.tsirpanis.gr.
