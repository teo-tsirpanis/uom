# Κατανεμημένα Συστήματα ~ Εργαστήριο 2

### Θοδωρής Τσιρπάνης (`dai19090`)

## Οδηγίες εκτέλεσης

``` bash
cd SigmaBank
```

### Server

``` bash
docker compose up
```

### Client

``` bash
docker build -f ./Client.Dockerfile -t dai19090/sigma-bank-client .
docker run -it --rm --network host dai19090/sigma-bank-client
```

## Τεχνολογίες που χρησιμοποιήθηκαν

Το επίπεδο δεδομένων χρησιμοποιεί τη βάση δεδομένων Microsoft SQL Server, της οποίας η Developer Edition είναι δωρεάν για σκοπούς ανάπτυξης.

Το επίπεδο επιχειρηματικής λογικής είναι γραμμένο σε C# και εκτελείται στο περιβάλλον .NET 6. Για την επικοινωνία με τη βάση χρησιμοποιεί την τεχνολογία διασύνδεσης ADO.NET (το αντίστοιχο του JDBC για το .NET), και συγκεκριμένα το πακέτο `Microsoft.Data.SqlClient` για υποστήριξη βάσεων SQL Server, ανοίγοντας μια νέα σύνδεση για κάθε αίτημα. Το connection string για τη βάση λαμβάνεται από μία μεταβλητή περιβάλλοντος.

Το επίπεδο παρουσίασης, επίσης γραμμένο σε C# και εκτελούμενο στο .NET 6 αποτελείται από μια διαδραστική εφαρμογή γραμμής εντολών. Λαμβάνει τη διεύθυνση IP και την θύρα από μια μεταβλητή περιβάλλοντος, και δημιουργεί μια νέα σύνδεση ανά αίτημα.

### Το πρωτόκολλο επικοινωνίας

Τα δύο τελευταία επίπεδα επικοινωνούν μεταξύ τους με sockets, χρησιμοποιώντας ένα αυτοσχέδιο πρωτόκολλο, όπου σε κάθε μήνυμα αποστέλλεται ένας ακέραιος τριάντα δύο bit, ακολουθούμενος από τόσα bytes όσα ο αριθμός αυτός, που περιέχουν ένα αντικείμενο JSON κωδικοποιημένο με UTF-8. Παρατίθεται παράδειγμα μηνύματος και ενδεικτικών απαντήσεων σε αυτό:

``` json
{"ProtocolVersion":1,"CommandName":"DepositAsync","Arguments":[4,226]}
```

``` json
{"Successful":true,"Result":{"AccountId":4,"Owner":1,"Balance":521}}
```

``` json
{"Successful":false,"Message":"Account does not exist"}
```

Και τα τρία επίπεδα χρησιμοποιούν containers του Docker, με τα δύο πρώτα να χρησιμοποιούν και το Docker Compose για την ευκολότερη διαχείρισή τους. Το επίπεδο παρουσίασης εξαιρείται από το Docker Compose για να είναι ευκολότερη η ταυτόχρονη εκτέλεση πολλαπλών στιγμιοτύπων του.

## Οργάνωση του κώδικα

Ο πηγαίος κώδικας του προγράμματος αποτελείται από τρία project, ένα για το επίπεδο επιχειρηματικής λογικής, ένα για το επίπεδο παρουσίασης, και ένα με κοινόχρηστο κώδικα (το επίπεδο δεδομένων περιγράφεται στο αρχείο `compose.yml`). Ακολουθεί μια τμηματοποιημένη αρχιτεκτονική, επιτρέποντας εύκολες μελλοντικές επεκτάσεις και αλλαγές στο σύστημα. Είναι βελτιστοποιημένο στο μέτρο του λογικού χρησιμοποιώντας για παράδειγμα τεχνικές ασύγχρονου προγραμματισμού με τις λέξεις-κλειδιά `async` και `await`, επιτρέποντας την εύκολη κλιμακωσιμότητα του συστήματος.

Ακολουθεί μια λίστα με τα "ενδιαφέροντα" αρχεία του κώδικα:

### SigmaBank.Shared

* `DomainTypes.cs`: Ορίζει τους κύριους τύπους του συστήματος, όπως των πληροφοριών λογαριασμού και χρήστη. Θεμελιώδης είναι η διεπαφή `IBank`, που αφαιρεί τις λειτουργίες τράπεζας που υποστηρίζει το σύστημα.

* `AbstractRpcReceiver.cs`: Περιέχει την λογική λήψης, επεξεργασίας, και απάντησης σε εισερχόμενες εντολές βάσει του αυτοσχέδιου πρωτοκόλλου που περιγράφτηκε παραπάνω. Ο κώδικας είναι αφηρημένος ως προς το μέσο μεταφοράς των εντολών, και ως προς την λογική της εκτέλεσής τους.

* `RpcSender.cs`: Περιέχει την λογική αποστολής εντολών, και λήψης της απάντησής τους βάσει του αυτοσχέδιου πρωτοκόλλου που περιγράφτηκε παραπάνω. Ο κώδικας είναι αφηρημένος ως προς το μέσο μεταφοράς των εντολών.

### `SigmaBank.Server`

* `BankImplementation.cs`: Υλοποιεί την διεπαφή `IBank` επικοινωνόντας με το επίπεδο δεδομένων. Γραμμένος με τους τύπους του ADO.NET, ο κώδικας είναι αφηρημένος ως προς τον τύπο της βάσης δεδομένων.

* `BankRpcReceiver.cs`: Κληρονομεί την κλάση `AbstractRpcReceiver`, και προωθεί τις εντολές με τα ορίσματά τους σε ένα αντικείμενο τύπου `IBank`.

* `SocketListener.cs`: "Ακούει" εισερχόμενες συνδέσεις από ένα socket και τις προωθεί σε κάποιον αφηρημένο δέκτη.

* `Program.cs`: Το σημείο εισόδου του επιπέδου επιχειρηματικής λογικής, αρχικοποιεί το σχήμα της βάσης δεδομένων, συνδέει τις τρεις παραπάνω κλάσεις μεταξύ τους, και εκκινεί τον διακομιστή. Επίσης εγκαθιστά γεγονότα για τον ομαλό τερματισμό του συστήματος σε περίπτωση σήματος τερματισμού (SIGTERM) που εκδίδει το Docker.

> Δεν υπάρχει μέθοδος `Main`· νεότερες εκδόσεις της C# δίνουν τη δυνατότητα στο αρχείο με το σημείο εισόδου να το δηλώνει χύμα, κάτι που χρησιμοποιήθηκε.

### `SigmaBank.Client`

* `BankClient.cs`: Υλοποιεί την διεπαφή `IBank` στέλνοντας εντολές με τη βοήθεια της κλάσης `RpcSender`. Ο κώδικας είναι αφηρημένος ως προς το μέσο μεταφοράς των εντολών.

* `InteractiveBank.cs`: Λαμβάνει εντολές από τον χρήστη μέσω της κονσόλας, και τις στέλνει σε ένα αντικείμενο τύπου `IBank`, και να εμφανίσει την απάντησή τους.

> Χάρη στην οργάνωση του συστήματος, τίποτα δε μας εμποδίζει από το να αντιγράψουμε το αρχείο αυτό στον server, και με λίγες αλλαγές στο σημείο εισόδου του να κάνουμε το σύστημα από 3-tier σε 2-tier. Μια τέτοια τεχνική θα ήταν πολύ χρήσιμη κατά την αντιμετώπιση σφαλμάτων.

* `Program.cs`: Το σημείο εισόδου του επιπέδου παρουσίασης, περιέχει τη λογική σύνδεσης των sockets με το επίπεδο επιχειρηματικής λογικής, συνδέει τις δύο παραπάνω κλάσεις μεταξύ τους, και δίνει τον έλεγχο στην κλάση `InteractiveBank`.

## Πιθανές επεκτάσεις

Μια ενδιαφέρουσα επέκταση του συστήματος θα ήταν η χρήση ασφαλούς επικοινωνίας μεταξύ των επιπέδων επιχειρηματικής λογικής και παρουσίασης με τη χρήση του πρωτοκόλλου TLS. Το .NET υποστηρίζει το πρωτόκολλο στις βιβλιοθήκες του, αλλά επειδή η χρήση του TLS θα δημιουργούσε ερωτήματα σχετικά με την διαχείριση των σχετικών πιστοποιητικών, και λόγω προνικών περιορισμών, δεν έγιναν προσπάθειες για την υλοποίηση της ιδέας.

## Ευχαριστίες

Αξίζει ιδιαίτερη μνεία το εργαλείο [GitHub Copilot](https://copilot.github.com/) για την πολύτιμη βοήθειά του, ιδιαίτερα κατά την συγγραφή των αρχείων `BankImplementation.cs` και `InteractiveBank.cs`.
